#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <unistd.h>

#define ERROR (-1)

void error(const char * msg)
{
    perror(msg);
    exit(EXIT_FAILURE);
}

void copy_addr(char * buffer, unsigned long addr)
{
    buffer[0] = addr;
    buffer[1] = addr >> 8;
    buffer[2] = addr >> 16;
    buffer[3] = addr >> 24;
}

void oflow(char * shellcode)
{
    char buffer[51];
    
    memcpy(buffer, shellcode, sizeof (buffer));
    
    copy_addr(buffer + sizeof (buffer) + 4, buffer);
}

int main(int argc, char * argv[])
{
    int client, server;
    char shellcode[52];
    struct sockaddr_in addr;
    
    bzero(&addr, sizeof(addr));
    
    addr.sin_addr.s_addr = INADDR_ANY;
    addr.sin_port        = htons(atoi(argv[1]));
    addr.sin_family      = AF_INET;
    
    client = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    
    if (client == ERROR)
        error("socket");
    
    puts("socket created.\n");
    puts("binding...\n");
    
    if (bind(client, (struct sockaddr *)&addr, sizeof(addr)) == ERROR)
        error("bind");
    
    puts("binded.\n");
    puts("listening...\n");
    
    if (listen(client, 1) == ERROR)
        error("listen");
    
    server = accept(client, NULL, NULL);
    
    if (server == ERROR)
        error("accept");
    
    if (recv(server, shellcode, sizeof(shellcode), 0) == ERROR)
        error("recv");
    
    puts("payload received.\n");
	
	oflow(shellcode);
	
	close(client);
    
    return 0;
}
