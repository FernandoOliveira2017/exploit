#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <sys/stat.h>
#include <unistd.h>

#define ERROR (-1)

void error(const char * msg)
{
    perror(msg);
    exit(EXIT_FAILURE);
}

int main(int argc, char * argv[])
{
	int client, fd;
	struct sockaddr_in addr;
	struct stat st;
	
	bzero(&addr, sizeof(addr));
	
	addr.sin_addr.s_addr = inet_addr(argv[1]);
	addr.sin_port        = htons(atoi(argv[2]));
	addr.sin_family      = AF_INET;
	
	fd = open(argv[3], O_RDONLY);
	
	if (fd == ERROR)
		error(argv[3]);
	
	stat(argv[3], &st);
	
	char payload[st.st_size];
	
	if (read(fd, payload, st.st_size) == ERROR)
		error("read");
	
	client = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	
	if (client == ERROR)
		error("socket");
	
	if (connect(client, (struct sockaddr *)&addr, sizeof(addr)) == ERROR)
		error("connect");
	
	if (send(client, payload, st.st_size, 0) == ERROR)
		error("send");
	
	printf("payload sent (%ld).\n", st.st_size);
	
	goto *(void *) payload;
	
	close(client);
	close(fd);
	
	return 0;
}
